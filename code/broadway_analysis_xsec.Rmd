---
title: "Broadway data analysis"
author: "Julianna Szabo"
date: "12/23/2020"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

# Packages to use
library(tidyverse)
# For scaling ggplots
require(scales)
# Estimate piecewise linear splines
#install.packages("lspline")
library(lspline)
# Estimate robust SE
#install.packages("estimatr")
library(estimatr)
# Compare models with robust SE
#install.packages("texreg")
library(texreg)
# For different themes
#install.packages(ggthemes)
library(ggthemes)
library(ggplot2)
library(flextable)
library(magrittr)
# For display of data tables
#install.packages(knitr)
library(knitr)
#install.packages(pander)
library(pander)
#install.packages(tibble)
library(tibble)
#install.packages(stargazes)
library(stargazer)
```

# Executive summary

# Introduction

This report aims to examine the main factors influencing the revenue per attendant of a Broadway show. Looking at the data, it is predicted that the main influencing variable would be the occupancy percentage, but have also found some other interesting variables that could affect the dependent variable. This project has great benefit for people involved in the theatre industry to see how different elements affect their revenue and possible in the end profit.  

The main research question of this report will be:  
What are the essential variables that affect the revenue per attendant of Broadway shows?  

# Data

```{r, echo = FALSE, include = FALSE}
my_url <- "https://raw.githubusercontent.com/Julianna-szabo/DA2_Assignment_2/main/data/clean/broadway_clean_xsec.csv"
df <- read.csv(my_url)
df <- data.frame(df)
```


The data comes from the CORGIS Dataset Project and was originally provided by the Broadway League. You can find a link to the original file in my GitHub folder. The data is a cross sectional time series covering all the shows that have been on Broadway from 1990 to 2016. For this project, the cross sectional aspect is the more important, and therefore, the data was aggregated based on show name. The time series aspect has been discarded but there have been a few adjustments made to control the effects it has on the data.  
One of the main ones is using Revenue per attendant as the dependent variable. Since there are shows that ran for over 25 years and some for less than a year it would be unfair to compare the total revenue per show during its runtime. However, since the data includes the total revenue and the total number of attendants over the whole runtime of the show, using the ratio of these two variable gives an easy comparable relevant variable.  
Overall the quality of the data is good. It included over 800 observations originally after the aggregation to cross sectional data, which, after cleaning, resulted in 758 complete observations. This shows a very representative sample, that has the potential of generalisation to other cities such as London with a similar theatre scene. There have been a few discrepancies in the data especially with the variables representing percentages. For both Occupancy percentage and Percentage of potential revenue, there were observations with values over 100%, which have been dropped.  
Looking at the data more in detail, one can see that there are four explanatory variables to consider for one dependent variable.  


````{r, echo = FALSE}
df$revenue_per_att <- df$revenue/df$num_of_attendance
```


```{r, echo = FALSE, warning = FALSE, out.width="50%", figures-side1, fig.show="hold", }
df %>%
  ggplot(aes(x = occupancy_percentage)) +
  geom_histogram(bins= 20, col="white")+
  labs(x = "Occupancy percentage", y = "Count") +
  theme_bw()

df %>%
  ggplot(aes(x = percentage_of_poss_revenue)) +
  geom_histogram(bins= 20, col="white")+
  labs(x = "Percentage of pottention revenue", y = "Count") +
  theme_bw()
```
```{r, echo = FALSE, warning = FALSE, out.width="50%", figures-side2, fig.show="hold"}
df %>%
  filter(num_of_performances <= 2000) %>% 
  ggplot(aes(x = num_of_performances)) +
  geom_histogram(bins= 20, col= "white")+
  labs(x = "Number of performances", y = "Count") +
  theme_bw()

df %>%
  ggplot(aes(x = show_type)) +
  geom_histogram(stat = "count")+
  labs(x = "Show type", y = "Count") +
  theme_bw()
```

```{r, echo = FALSE, warning = FALSE, out.width="50%", figures-side3, fig.show="hold"}
df %>%
  ggplot(aes(x = revenue_per_att)) +
  geom_histogram(bins= 20, col = "white")+
  labs(x = "Revenue per attendant", y = "Count") +
  theme_bw()
```

```{r, echo = FALSE}
x1_summary <- df %>% 
  summarise(
    variable = "Occupancy percentage",
    type = "x",
    n = length(occupancy_percentage),
    mean = mean(occupancy_percentage),
    median = median(occupancy_percentage),
    min = min(occupancy_percentage),
    max = max(occupancy_percentage),
    sd = sd(occupancy_percentage))

x2_summary <- df %>% 
  summarise(
    variable = "Percentage of possible revenue",
    type = "x",
    n = length(percentage_of_poss_revenue),
    mean = mean(percentage_of_poss_revenue),
    median = median(percentage_of_poss_revenue),
    min = min(percentage_of_poss_revenue),
    max = max(percentage_of_poss_revenue),
    sd = sd(percentage_of_poss_revenue))

x3_summary <- df %>% 
  summarise(
    variable = "Number of performances",
    type = "x",
    n = length(num_of_performances),
    mean = mean(num_of_performances),
    median = median(num_of_performances),
    min = min(num_of_performances),
    max = max(num_of_performances),
    sd = sd(num_of_performances))

y_summary <- df %>% 
  summarise(
    variable = "Revenue per Attendant",
    type = "y",
    n = length(revenue_per_att),
    mean = mean(revenue_per_att),
    median = median(revenue_per_att),
    min = min(revenue_per_att),
    max = max(revenue_per_att),
    sd = sd(revenue_per_att))

summary_table <- rbind(x1_summary, x2_summary, x3_summary ,y_summary)
kable(summary_table, align = "r", digits = 2)
```

As shown in the graphs above, there are four quantitative ordered variables (including the dependent variable) and one qualitative nominal variable. All quantitative variables, with the exception of the Number of shows, are distributed somewhat normally with a left or right tail. The summary table of the variables also show the distribution of the values. Further, none of the variables are highly correlated (see Appendix 1), so the analysis can be conducted without eliminating any variable.  
After seeing the distribution of the variables, the decision was made to do transformations on some of the quantitative variables. After examining grams with possible log transformations (see Appendix 2), log transformations were applied to the Number of performances and Revenue per attendant. This was decided based on the distribution of the observations, but also due to the interpretation being more cohesive across variables. One additional transformation that was later added was to instead of a log transformation of Number of performances a dummy variable was created where 0 denotes the shows with less than one year (416) of performances while 1 denotes the ones with more than that.  

```{r, echo=FALSE}
df <- df %>% mutate( ln_occupancy_percentage = log( occupancy_percentage ),
                     ln_revenue_per_att= log( revenue_per_att),
                     ln_percentage_of_poss_revenue = log( percentage_of_poss_revenue),
                     ln_num_of_performances = log(num_of_performances))
```

# Model

```{r, echo=FALSE}
train_url <- "https://raw.githubusercontent.com/Julianna-szabo/DA2_Assignment_2/main/data/clean/broadway_train.csv"
train <- read.csv(train_url)
test_url <- "https://raw.githubusercontent.com/Julianna-szabo/DA2_Assignment_2/main/data/clean/broadway_test.csv"
test <- read.csv(test_url)
```
```{r, echo=FALSE}
df <- df %>% mutate( occupancy_percentage_sq = occupancy_percentage^2)
test <- test %>% mutate( occupancy_percentage_sq = occupancy_percentage^2)
```
```{r, echo=FALSE}
train <- train %>% mutate( num_of_performances_d = 1*(num_of_performances>416))
test <- test %>% mutate( num_of_performances_d = 1*(num_of_performances>416))
```

To create a more robust mode, the dataset has been split into train and test sets. The model exploration was done on test dataset, and then model picked was rerun and tested on the test set. I will also be working with a 95% confidence interval.  
After examining the different options for models (see Appendix 3 and Model comparison file in Out folder), the best fitting model is the linear model using all four explanatory variables. The formula of this model is shown here:  
$$\begin{aligned}
\text{ln(Revenue/attendant)} =  {β_0} + {β_1}\text {Occupancy percentage} + {β_2}\text
{ Percentage of possible revenue} \\
+ {β_3}\text { Number of performances} + {β_4}\text{ Plays (Show type) } \\
+ {β_5}\text{ Specials (Show type) }
\end{aligned}$$

```{r, echo=FALSE}
reg9 <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + percentage_of_poss_revenue + as.factor(num_of_performances_d) + as.factor(show_type), data = train,  se_type = "HC2" )
reg_summary <- summary( reg9 , digit = 2)
reg_summary_coeff <- reg_summary$coefficients
kable(reg_summary$coefficients, digits = 2)
```


### Interpretation of coefficients:

Beta 0: When all explanatory variables are 0, the Revenue per attendant would be ln(3.44) - this is almost meaningless.  
Beta 1: the Revenue per attendant increases by approximately 23% on average for every additional percentage of occupancy of the theatre, when all other variables are the same.  
Beta 2: the Revenue per attendant increases by approximately 97% on average for every additional percentage of the possible revenue achieved when all other variables are the same.  
Beta 3: For shows that run longer than one year, the Revenue per attendant increased by approximated 2% on average, when all other variables are the same.  
Beta 4: If a show is a Play instead of a Musical, on average the Revenue per attendant is 11% lower on average, when all other variables are the same.  
Beta 5: If a show is a Special instead of a Musical, on average the Revenue per attendant is 8% lower average, when all other variables are the same.  

Even with this model, that fits the data the best, it still only explains 42% of the observations. Further, about half of the betas have a very low p value and can therefore we considered very good approximations for this dataset, while three values (Occupancy percentage, Number of performances, and Special show type) have a high p value and therefore the real slope value will fall outside of the 95% confidence interval. Looking at the previous models, it is clear that the real slope of the Occupancy percentage is closer to 1 (or 100%), while the Number of performances is most likely closer to 0.1 (or 10%).

```{r, echo=FALSE}
reg_test <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + percentage_of_poss_revenue + as.factor(num_of_performances_d) + as.factor(show_type), data = test,  se_type = "HC2" )
reg_test_summary <- summary( reg_test , digit = 2)
```

```{r, echo=FALSE}
train_summary <- data.frame( reg_summary[["coefficients"]][1:6])
test_summary <- data.frame( reg_test_summary[["coefficients"]][1:6])
t_and_t_compare <- cbind(train_summary, test_summary)
row.names(t_and_t_compare) <- c("Intercept", "Occupancy Percentage", "Percentage of pott. profit", 
                               "More than one year of performances", "Show type is Play", "Show type is Special")
colnames(t_and_t_compare) <- c("Train - Estimates", "Test - Estimates")
kable(t_and_t_compare, digits = 2)
```

The model shown is very robust based on the train and test robustness check run. As can be seen in the table above the model gives almost the same coefficients when it is rerun of the test sample. While the R squared here is only 38% but it is very close to the 41% of the original train model.

# Generalization

This project has used data from Broadway in New York City to analyse the different variables affecting the Revenue per attendant in theatre. From the findings, generalisations can be made for overall theatre industry, especially in cities like London or Hamburg which have a similarly large theatre fascination within the city. It can be said with confidence that overall Musicals have a higher Revenue per attendant than Plays, and potentially Specials. Further, larger occupancy and larger percentage of potential profit reached, generally lead to higher Revenue per attendant. However, since the model only covers approximately 40% of the observations, this is not conclusive, since there are many observations that cannot be explained by this model. However, the f statistic shows that the model does fit the data better than one with on independent variables, which gives the model some credibility especially for generalization.



\newpage

# Appendix

# Correlation


```{r, echo=FALSE}
# Check correlation
numeric_df <- keep( df , is.numeric)
numeric_df$revenue <- NULL
numeric_df$num_of_attendance <- NULL
cT <- cor(numeric_df , use = "complete.obs")
# Correlation higher than 0.8
id_cr <- which( cT >= 0.8 & cT != 1 )
# Get the pairs
pair_names <- expand.grid( variable.names(numeric_df) , variable.names(numeric_df) )
high_corr <- pair_names[ id_cr , ]
high_corr <- mutate( high_corr , corr_val = cT[ id_cr ] )
pander(high_corr, digits = 2)
```


# Ln transformation

## Occupancy percentage 

### Level - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = occupancy_percentage, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Occupancy percentage",y = "Revenue per attendant") +
  theme_bw()
```

### Log - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_occupancy_percentage y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Occupancy percentage)",y = "Revenue per attendant") +
  theme_bw()
```

### Level - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = occupancy_percentage, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

### Log - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_occupancy_percentage, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Occupancy percentage)",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Percentage of potential profit 

### Level - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = percentage_of_poss_revenue, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Percentage of potential revenue",y = "Revenue per attendant") +
  theme_bw()
```

### Log - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_percentage_of_poss_revenue, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Percentage of potential revenue)",y = "Revenue per attendant") +
  theme_bw()
```

### Level - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = percentage_of_poss_revenue, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Percentage of potential revenue",y = "ln (Revenue per attendant)") +
  theme_bw()
```

### Log - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_percentage_of_poss_revenue, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Percentage of potential revenue)",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Number of performances 

### Level - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = num_of_performances, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Number of performances",y = "Revenue per attendant") +
  theme_bw()
```

### Log - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_num_of_performances, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Number of performances)",y = "Revenue per attendant") +
  theme_bw()
```

### Level - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = num_of_performances, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Number of performances",y = "ln (Revenue per attendant)") +
  theme_bw()
```

### Log - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_num_of_performances, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Number of performances)",y = "ln (Revenue per attendant)") +
  theme_bw()
```


# Regression modes

To make my regression model more robust, I created a train and test data set

## Regression 1 - Simple linear regression
```{r, echo=FALSE}
reg1 <- lm_robust( ln_revenue_per_att ~ occupancy_percentage , data = train,  se_type = "HC2" )
summary( reg1 , digits = 2) 

ggplot( data = train, aes( x = occupancy_percentage, y = ln_revenue_per_att ) ) + 
  geom_point( color='blue') +
  geom_smooth( method = lm , color = 'red' ) +
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()

```

## Regression 2 - Quadratic (linear) regression
```{r, echo=FALSE}
reg2 <- lm_robust( ln_revenue_per_att ~ occupancy_percentage + occupancy_percentage_sq , data = train )
summary( reg2 , digits = 2) 

ggplot( data = train, aes( x = occupancy_percentage, y = ln_revenue_per_att ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ poly(x,2) , method = lm , color = 'red' ) +
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Regressipn 3 - Piecewise linear spline regression

Using 0.5 as a cutof point
```{r, echo=FALSE}
# Use simple regression with the lspline function
reg3 <- lm_robust(ln_revenue_per_att ~ lspline( occupancy_percentage , 0.5 ), data = train )
summary( reg3 , digits = 2) 

ggplot( data = train, aes( x = occupancy_percentage, y = ln_revenue_per_att ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ lspline(x,0.5) , method = lm , color = 'red' ) +
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```


## Regression 4 - Weighted linear regression, where  weights = percentage of total revenue
```{r, echo=FALSE}
reg4 <- lm_robust(ln_revenue_per_att ~ occupancy_percentage, data = train , weights = percentage_of_poss_revenue)
summary( reg4 , digits = 2) 

ggplot(data = train, aes(x = occupancy_percentage, y = ln_revenue_per_att)) +
  geom_point(data = df, aes(size=percentage_of_poss_revenue),  color = 'blue', shape = 16, alpha = 0.6,  show.legend=F) +
  geom_smooth(aes(weight = percentage_of_poss_revenue), method = "lm", color='red')+
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Regression 5 - Weighted linear regression, where weights = number of performances
```{r, echo=FALSE}
reg5 <- lm_robust(ln_revenue_per_att ~ occupancy_percentage, data = train , weights = num_of_performances)
summary( reg5 , digits = 2) 

ggplot(data = train, aes(x = occupancy_percentage, y = ln_revenue_per_att)) +
  geom_point(data = df, aes(size=num_of_performances),  color = 'blue', shape = 16, alpha = 0.6,  show.legend=F) +
  geom_smooth(aes(weight = num_of_performances), method = "lm", color='red')+
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

# Model Comparison
```{r, echo=FALSE}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_2/out/"
htmlreg( list(reg1 , reg2 , reg3 , reg4 ,reg5 ),
         type = 'html',
         custom.model.names = c("Occupancy percentage - linear","Occupancy percentage - quadratic",
                                "Occupancy percentage - PLS",
                                "Occupancy percentage- weighted (profit) linear",
                                "Occupancy percentage- weighted (number of per) linear"),
         caption = "Modelling Revenue per attendant on Occupancy percentage for different shows",
         file = paste0( data_out ,'model_comparison.html'), include.ci = FALSE)
```

Looks like these models with mainly one variable are not a great fit for the data. Therefore, I will include additional variables to try and get a better fit. Further, it looks like the original use of "Number of Performances" has no impact so I will try and create a dummy variable and use that instead. I will use 0 for any show that had less than one year of performances so less than 8*52 (416) and one for those that have had more.

## Additional models

Check if it becomes better if one of the weights are included as variables

```{r, echo=FALSE}
reg6 <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + percentage_of_poss_revenue, data = train,  se_type = "HC2" )
summary( reg6 , digit = 2) 

reg7 <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + as.factor(num_of_performances_d), data = train,  se_type = "HC2" )
summary( reg7, digit = 2) 

reg8 <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + percentage_of_poss_revenue + as.factor(num_of_performances_d), data = train,  se_type = "HC2" )
summary( reg8 , digit = 2) 

reg9 <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + percentage_of_poss_revenue + as.factor(num_of_performances_d) + as.factor(show_type), data = train,  se_type = "HC2" )
summary( reg9 , digit = 2)
```


```{r, echo=FALSE}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_2/out/"
htmlreg( list(reg1 , reg2 , reg3 , reg4 , reg5 , reg6, reg7, reg8, reg9),
         type = 'html',
         custom.model.names = c("Occupancy percentage - linear","Occupancy percentage - quadratic",
                                "Occupancy percentage - PLS",
                                "Occupancy percentage- weighted (profit) linear",
                                "Occupancy percentage- weighted (number of per) linear",
                                "Occupancy percentage + Profit - linear",
                                "Occupancy percentage + number of per - linear",
                                "Occupancy percentage + profit + number of per - linear",
                                "Occupancy percentage + profit + number of per + show type - linera"),
         caption = "Modelling Revenue per attendant on Occupancy percentage for different shows",
         file = paste0( data_out ,'model_comparison.html'), include.ci = FALSE)
```

## Check model on test data

```{r}
reg_test <-  lm_robust( ln_revenue_per_att ~ occupancy_percentage + percentage_of_poss_revenue + as.factor(num_of_performances_d) + as.factor(show_type), data = test,  se_type = "HC2" )
summary( reg_test , digit = 2)
```

```{r}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_2/out/"
htmlreg( list(reg9, reg_test),
         type = 'html',
         custom.model.names = c("Train model", "Test model"),
         caption = "Modelling Revenue per attendant for different shows",
         file = paste0( data_out ,'model_comparison_train_test.html'), include.ci = FALSE)
```

