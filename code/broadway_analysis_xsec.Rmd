---
title: "Broadway data analysis"
author: "Julianna Szabo"
date: "12/23/2020"
output: pdf_document
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

# Packages to use
library(tidyverse)
# For scaling ggplots
require(scales)
# Estimate piecewise linear splines
#install.packages("lspline")
library(lspline)
# Estimate robust SE
#install.packages("estimatr")
library(estimatr)
# Compare models with robust SE
#install.packages("texreg")
library(texreg)
# For different themes
#install.packages(ggthemes)
library(ggthemes)
library(ggplot2)
library(flextable)
library(magrittr)
# For display of data tables
#install.packages(knitr)
library(knitr)
#install.packages(pander)
library(pander)
#install.packages(tibble)
library(tibble)
#install.packages(stargazes)
library(stargazer)
```

# Executive summary


## Research question

Is there a correlation between the occupancy percentage of a show and the revenue per attendant?  
I will be looking for causality.

## Data

```{r, echo = FALSE, include = FALSE}
my_url <- "https://raw.githubusercontent.com/Julianna-szabo/DA2_Assignment_2/main/data/clean/broadway_clean_xsec.csv"
df <- read.csv(my_url)
df <- data.frame(df)
```


The data is very complete and representative. I have removed some missing values during the cleaning process but it was a very small percentage. Further some measures were lost by switching from a time series to a cross sectional data set. However, I aggregated on the show name, which lets me keel the most amount of detail. Most of the variables are quantitative so that means they measure what they decribe.
I will use using Revenue / Attendant, where Revenue is measured as the gross revenue of the show, and attendants which are measured as total number of people who attended the show.

My x variable will be Occupancy percentage (capacity_filled)
My y variable will be Revenue / Attendant which I will calculate based on revenue and attendant

````{r, echo = FALSE}
df$revenue_per_att <- df$revenue/df$num_of_attendance
```


There may be some measurement error in y, which is classic and doesn't affect the slope. There may be some measuement error in x which could also be classic, which does affect the slope.


# Summary of variables

```{r, echo = FALSE, warning = FALSE, out.width="50%", figures-side1, fig.show="hold"}
df %>%
  ggplot(aes(x = capacity_filled)) +
  geom_histogram(bins= 20, col="white")+
  labs(x = "Occupancy percentage", y = "Count") +
  theme_bw()

df %>%
  ggplot(aes(x = percentage_of_poss_profit)) +
  geom_histogram(bins= 20, col="white")+
  labs(x = "Percentage of pottention profit", y = "Count") +
  theme_bw()
```
```{r, echo = FALSE, warning = FALSE, out.width="50%", figures-side2, fig.show="hold"}
df %>%
  filter(num_of_performances <= 2000) %>% 
  ggplot(aes(x = num_of_performances)) +
  geom_histogram(bins= 20, col= "white")+
  labs(x = "Number of performances", y = "Count") +
  theme_bw()

df %>%
  ggplot(aes(x = show_type)) +
  geom_histogram(stat = "count")+
  labs(x = "Show type", y = "Count") +
  theme_bw()
```

```{r, echo = FALSE, warning = FALSE, out.width="50%", figures-side3, fig.show="hold"}
df %>%
  ggplot(aes(x = revenue_per_att)) +
  geom_histogram(bins= 20, col = "white")+
  labs(x = "Revenue per attendant", y = "Count") +
  theme_bw()
```

```{r, echo = FALSE}
x1_summary <- df %>% 
  summarise(
    variable = "Occupancy percentage",
    type = "x",
    n = length(capacity_filled),
    mean = mean(capacity_filled),
    median = median(capacity_filled),
    min = min(capacity_filled),
    max = max(capacity_filled),
    sd = sd(capacity_filled))

x2_summary <- df %>% 
  summarise(
    variable = "Percentage of possible profit",
    type = "x",
    n = length(percentage_of_poss_profit),
    mean = mean(percentage_of_poss_profit),
    median = median(percentage_of_poss_profit),
    min = min(percentage_of_poss_profit),
    max = max(percentage_of_poss_profit),
    sd = sd(percentage_of_poss_profit))

x3_summary <- df %>% 
  summarise(
    variable = "Number of performances",
    type = "x",
    n = length(num_of_performances),
    mean = mean(num_of_performances),
    median = median(num_of_performances),
    min = min(num_of_performances),
    max = max(num_of_performances),
    sd = sd(num_of_performances))

y_summary <- df %>% 
  summarise(
    variable = "Revenue per Attendant",
    type = "y",
    n = length(revenue_per_att),
    mean = mean(revenue_per_att),
    median = median(revenue_per_att),
    min = min(revenue_per_att),
    max = max(revenue_per_att),
    sd = sd(revenue_per_att))

summary_table <- rbind(x1_summary, x2_summary, x3_summary ,y_summary)
kable(summary_table, align = "c", digits = 2)
```

Looks like they are distributed somehwat normall, but y has a long right tail, while x has more of a left tail. Also looking at x, there are a few outliers, since a percentage should not be larger than 1. Therefore I will remove these from the set.

# Correlation


# Ln transformations

```{r, echo=FALSE}
df <- df %>% mutate( ln_capacity_filled = log( capacity_filled ),
                     ln_revenue_per_att= log( revenue_per_att),
                     ln_percentage_of_poss_profit = log( percentage_of_poss_profit),
                     ln_num_of_performances = log(num_of_performances))
```

Appendix

Log transformaton on y
level of occupancy percentage
level of percentage of possible profit
log  of number of performances

# Regression Models

```{r, echo=FALSE}
train <- df[sample(nrow(df), 640), ]
test <- df[ !(df$show_name %in% train$show_name), ]
```


```{r, echo=FALSE}
df <- df %>% mutate( capacity_filled_sq = capacity_filled^2)
test <- test %>% mutate( capacity_filled_sq = capacity_filled^2)
```

Decided on ....... model

\newpage

# Appendix

# Correlation


```{r, echo=FALSE}
# Check correlation
numeric_df <- keep( df , is.numeric)
numeric_df$revenue <- NULL
numeric_df$num_of_attendance <- NULL
cT <- cor(numeric_df , use = "complete.obs")
# Correlation higher than 0.8
id_cr <- which( cT >= 0.8 & cT != 1 )
# Get the pairs
pair_names <- expand.grid( variable.names(numeric_df) , variable.names(numeric_df) )
high_corr <- pair_names[ id_cr , ]
high_corr <- mutate( high_corr , corr_val = cT[ id_cr ] )
pander(high_corr, digits = 2)
```


# Ln transformation

## Occupancy percentage 

### Level - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = capacity_filled, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Occupancy percentage",y = "Revenue per attendant") +
  theme_bw()
```

### Log - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_capacity_filled, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Occupancy percentage)",y = "Revenue per attendant") +
  theme_bw()
```

### Level - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = capacity_filled, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

### Log - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_capacity_filled, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Occupancy percentage)",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Percentage of potential profit 

### Level - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = percentage_of_poss_profit, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Percentage of potential profit",y = "Revenue per attendant") +
  theme_bw()
```

### Log - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_percentage_of_poss_profit, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Percentage of potential profit)",y = "Revenue per attendant") +
  theme_bw()
```

### Level - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = percentage_of_poss_profit, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Percentage of potential profit",y = "ln (Revenue per attendant)") +
  theme_bw()
```

### Log - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_percentage_of_poss_profit, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Percentage of potential profit)",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Number of performances 

### Level - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = num_of_performances, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Number of performances",y = "Revenue per attendant") +
  theme_bw()
```

### Log - level regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_num_of_performances, y = revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Number of performances)",y = "Revenue per attendant") +
  theme_bw()
```

### Level - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = num_of_performances, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Number of performances",y = "ln (Revenue per attendant)") +
  theme_bw()
```

### Log - log regression
```{r, echo=FALSE}
df %>% 
  ggplot(aes(x = ln_num_of_performances, y = ln_revenue_per_att)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Number of performances)",y = "ln (Revenue per attendant)") +
  theme_bw()
```


# Regression modes

To make my regression model more robust, I created a train and test data set

## Regression 1 - Simple linear regression
```{r, echo=FALSE}
reg1 <- lm_robust( ln_revenue_per_att ~ capacity_filled , data = train,  se_type = "HC2" )
summary( reg1 , digits = 2) 

ggplot( data = train, aes( x = capacity_filled, y = ln_revenue_per_att ) ) + 
  geom_point( color='blue') +
  geom_smooth( method = lm , color = 'red' ) +
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()

```

## Regression 2 - Quadratic (linear) regression
```{r, echo=FALSE}
reg2 <- lm_robust( ln_revenue_per_att ~ capacity_filled + capacity_filled_sq , data = train )
summary( reg2 , digits = 2) 

ggplot( data = train, aes( x = capacity_filled, y = ln_revenue_per_att ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ poly(x,2) , method = lm , color = 'red' ) +
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Regressipn 3 - Piecewise linear spline regression

Using 0.5 as a cutof point
```{r, echo=FALSE}
# Define the cutoff for occupancy
cutoff <- 0.5
# Use simple regression with the lspline function
reg3 <- lm_robust(ln_revenue_per_att ~ lspline( capacity_filled , cutoff ), data = train )
summary( reg3 , digits = 2) 

ggplot( data = train, aes( x = capacity_filled, y = ln_revenue_per_att ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ lspline(x,cutoff) , method = lm , color = 'red' ) +
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```


## Regression 4 - Weighted linear regression, where  weights = percentage of total revenue
```{r, echo=FALSE}
reg4 <- lm_robust(ln_revenue_per_att ~ capacity_filled, data = train , weights = percentage_of_poss_profit)
summary( reg4 , digits = 2) 

ggplot(data = train, aes(x = capacity_filled, y = ln_revenue_per_att)) +
  geom_point(data = df, aes(size=percentage_of_poss_profit),  color = 'blue', shape = 16, alpha = 0.6,  show.legend=F) +
  geom_smooth(aes(weight = percentage_of_poss_profit), method = "lm", color='red')+
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

## Regression 5 - Weighted linear regression, where weights = number of performances
```{r, echo=FALSE}
reg5 <- lm_robust(ln_revenue_per_att ~ capacity_filled, data = train , weights = num_of_performances)
summary( reg5 , digits = 2) 

ggplot(data = train, aes(x = capacity_filled, y = ln_revenue_per_att)) +
  geom_point(data = df, aes(size=num_of_performances),  color = 'blue', shape = 16, alpha = 0.6,  show.legend=F) +
  geom_smooth(aes(weight = num_of_performances), method = "lm", color='red')+
  labs(x = "Occupancy percentage",y = "ln (Revenue per attendant)") +
  theme_bw()
```

# Model Comparison
```{r, echo=FALSE}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_2/out/"
htmlreg( list(reg1 , reg2 , reg3 , reg4 ,reg5 ),
         type = 'html',
         custom.model.names = c("Occupancy percentage - linear","Occupancy percentage - quadratic",
                                "Occupancy percentage - PLS",
                                "Occupancy percentage- weighted (profit) linear",
                                "Occupancy percentage- weighted (number of per) linear"),
         caption = "Modelling Revenue per attendant on Occupancy percentage for different shows",
         file = paste0( data_out ,'model_comparison.html'), include.ci = FALSE)
```

Looks like these models with mainly one variable are not a great fit for the data. Therefore, I will include additional variables to try and get a better fit. Further, it looks like the original use of "Number of Performances" has no impact so I will try and create a dummy variable and use that instead. I will use 0 for any show that had less than one year of performances so less than 8*52 (416) and one for those that have had more.

```{r, echo=FALSE}
train <- train %>% mutate( num_of_performances_d = 1*(num_of_performances>416))
test <- test %>% mutate( num_of_performances_d = 1*(num_of_performances>416))
```


## Additional models

Check if it becomes better if one of the weights are included as variables

```{r, echo=FALSE}
reg6 <-  lm_robust( ln_revenue_per_att ~ capacity_filled + percentage_of_poss_profit, data = test,  se_type = "HC2" )
summary( reg6 , digit = 2) 

reg7 <-  lm_robust( ln_revenue_per_att ~ capacity_filled + as.factor(num_of_performances_d), data = test,  se_type = "HC2" )
summary( reg7, digit = 2) 

reg8 <-  lm_robust( ln_revenue_per_att ~ capacity_filled + percentage_of_poss_profit + as.factor(num_of_performances_d), data = test,  se_type = "HC2" )
summary( reg8 , digit = 2) 

reg9 <-  lm_robust( ln_revenue_per_att ~ capacity_filled + percentage_of_poss_profit + as.factor(num_of_performances_d) + as.factor(show_type), data = test,  se_type = "HC2" )
summary( reg9 , digit = 2)
```

## Explore again

```{r, echo=FALSE}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_2/out/"
htmlreg( list(reg1 , reg2 , reg3 , reg4 , reg5 , reg6, reg7, reg8),
         type = 'html',
         custom.model.names = c("Occupancy percentage - linear","Occupancy percentage - quadratic",
                                "Occupancy percentage - PLS",
                                "Occupancy percentage- weighted (profit) linear",
                                "Occupancy percentage- weighted (number of per) linear",
                                "Occupancy percentage + Profit - linear",
                                "Occupancy percentage + number of per - linear",
                                "Occupancy percentage + profit + number of per - linear"),
         caption = "Modelling Revenue per attendant on Occupancy percentage for different shows",
         file = paste0( data_out ,'model_comparison.html'), include.ci = FALSE)
```

